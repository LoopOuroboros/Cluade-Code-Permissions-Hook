# Claude Code 权限钩子插件规范

> **📅 更新时间**: 2025-12-23

## 📋 目录

- [核心原则](#核心原则)
- [钩子机制概览](#钩子机制概览)
- [已部署插件列表](#已部署插件列表)
- [使用说明](#使用说明)
- [故障排查](#故障排查)

---

## 🔑 核心原则

### 当前状态
✅ **插件已部署完成**，在生产环境中运行

### 核心理念
1. **安全优先**：拦截危险命令，引导使用安全工具
2. **智能引导**：为每个拦截提供清晰的替代方案
3. **真实验证**：代码有效性通过实际使用验证

---

## 🏗️ 钩子机制概览

### 类型
- **PreToolUse Hook**：在工具执行前拦截
- **PostToolUse Hook**：在工具执行后处理（预留）

### 执行流程
1. 用户执行 Bash/Web 命令
2. 钩子触发权限检查
3. 基于规则决定放行或拦截
4. 返回友好提示或允许执行

---

## 📦 已部署插件列表

### Bash Permission Hook
**位置**：`~/.claude/plugins/cache/claude-code-permissions-hook/bash-permission-hook/1.2.0/`

**处理命令**：
- 拦截：`find`、`grep`（单独使用）、`cat`、`head`、`tail`、`sed`、`awk`、`curl`、`wget`
- 放行：管道接收端的 `grep`、`head`

**功能**：
- 智能管道位置检测
- 友好的中文提示
- 规则驱动的权限控制

### Web Permission Hook
**位置**：`~/.claude/plugins/cache/claude-code-permissions-hook/web-permission-hook/1.2.0/`

**处理工具**：`WebFetch`、`WebSearch`

**功能**：
- 推荐 MCP 服务替代
- 网络请求安全引导

### Win Path Check Hook
**位置**：`~/.claude/plugins/cache/claude-code-permissions-hook/win-path-check-hook/1.2.0/`

**功能**：
- 跨平台路径兼容性检查
- Windows 路径正确性提示

---

## 📚 使用说明

### 常用命令替代方案

| 原命令 | 替代工具 | 说明 |
|--------|----------|------|
| `find . -name "*.js"` | **Glob** | 模式匹配文件 |
| `grep "pattern" file` | **Grep** | 搜索文件内容 |
| `cat file.txt` | **Read** | 读取文件内容 |
| `sed 's/x/y/' file` | **Edit** | 编辑文件 |
| `head/tail file` | **Read** | 查看文件头部/尾部 |
| `curl url` | **WebFetch** | 网络请求 |
| `wget url` | **WebSearch** | 网络搜索 |

### 管道使用示例

✅ **正确用法**：
```bash
echo "test" | grep "test"      # grep在管道中被放行
echo "content" | head -10      # head在管道中被放行
```

⚠️ **需要改写**：
```bash
cat file.txt | head -10        # 改用: Read工具读取文件
find . | grep "config"         # 改用: Glob + Grep工具
```

---

## 🔧 故障排查

### 问题 1：命令被意外拦截

**可能原因**：
1. 命令属于危险类别
2. 不在管道接收端位置

**解决方法**：
- 查看本文档的替代方案
- 使用推荐的 Claude Code 内置工具

### 问题 2：提示信息不够清晰

**可能原因**：
1. 规则配置需要更新
2. 提示文本需要优化

**解决方法**：
- 检查配置文件：`~/.claude/plugins/cache/.../config/config.json`
- 更新建议和提示内容

---

## 🔒 禁止测试脚本

### 绝对禁止使用任何测试代码

为保证代码简洁性和生产环境的稳定性，本项目**严禁**使用任何形式的测试脚本和验证命令。

### 明确禁止的行为：

1. **禁止运行 `node tests/test.js`**
2. **禁止执行测试脚本验证代码逻辑**
3. **禁止使用 Node.js 命令直接测试功能**
4. **禁止通过命令行测试钩子响应**

### 验证标准：

- **唯一验证方式**：在 Claude Code 真实环境中执行实际命令
- **禁止本地测试**：不得使用 Node.js 或其他工具模拟测试
- **禁止验证脚本**：不得创建或运行任何测试验证脚本

### 紧急规定：禁止技术错误提示

#### 绝对禁止出现的错误信息：
❌ **"Hook PreToolUse:Bash denied this tool"**

#### 正确的用户提示应该是：
✅ **"⚠️ [命令名]命令被拦截，使用内置的[工具名]代替"**

例如：
- ✅ "⚠️ head命令被拦截，使用内置的Read工具代替"
- ✅ "⚠️ grep命令被拦截，使用内置的Grep工具代替"

#### 重要定义：
- **"Hook PreToolUse:Bash denied this tool" 是异常信息，不是系统提示**
- **出现此信息表明钩子响应格式错误，属于必须修复的 bug**
- **任何认为此信息是"正常系统提示"的想法都是错误的**
- **一旦出现此信息，必须追溯到插件代码并修复钩子返回格式**

#### 验证步骤：
1. 执行任何 Bash 命令
2. 检查返回信息格式
3. 如果出现技术性错误信息，立即修复插件代码
4. 确保用户只看到友好的中文提示

#### 修复标准：
- 钩子必须返回纯文本友好提示，不返回复杂 JSON 结构
- 拦截时返回：`"⚠️ [命令]命令被拦截，使用内置的[工具]代替"`
- 放行时返回：标准 JSON 格式 `{"hookSpecificOutput": {...}}`

#### 违反后果：
出现技术性错误信息而未修复，将被视为严重质量问题，可能导致插件回滚。

### 为什么禁止测试脚本：

1. **生产就绪**：插件已在生产环境验证可靠
2. **避免复杂性**：测试代码增加维护负担
3. **真实验证**：真实环境测试比模拟测试更准确
4. **资源节省**：减少不必要的测试用例维护

### 违反后果：

使用测试脚本将会被自动拒绝并记录违规行为。代码质量由实际使用中的表现来保证，而不是依赖单元测试。

---

## 📝 更新日志

- **2025-12-23**：移除测试代码，添加禁止测试脚本规定，重构文档
- **2025-12-22**：添加管道位置检测支持
- **2025-12-19**：初始版本创建

---

## 💬 维护说明

### 插件管理

查看已安装插件：
```bash
cat ~/.claude/plugins/installed_plugins.json
```

插件位置：
```
~/.claude/plugins/cache/claude-code-permissions-hook/
```

### 部署更新

插件文件更新后会自动同步到运行目录，无需手动部署。

---

## 💬 反馈与贡献

如有问题或改进建议，请在项目仓库创建 Issue。